# Starter Companions - ID and Bookmark Handling

## Overview

Starter companions are predefined templates shown to new users. They don't exist in the database until a user clicks "Launch Lesson".

## How IDs Work

### Before Creation (Display Only)
- **Location**: `constants/index.ts` → `starterCompanions` array
- **ID Format**: String like `"starter-1"`, `"starter-2"`, etc.
- **Purpose**: React key prop only (for mapping in JSX)
- **NOT stored in database**: These are just template definitions

```typescript
export const starterCompanions = [
  {
    id: "starter-1",  // ← Only for React keys, never sent to database
    subject: "maths",
    name: "Countsy the Number Wizard",
    // ...other fields
  },
];
```

### After Creation (Database)
- **When**: User clicks "Launch Lesson" on a starter companion
- **Action**: `createFromStarter()` inserts into Supabase
- **ID Format**: UUID auto-generated by Supabase (e.g. `"a1b2c3d4-..."`)
- **How**: Database column has `DEFAULT uuid_generate_v4()`

```typescript
// StarterCompanionCard passes only these fields:
const companion = await createFromStarter({
  name,       // ← No 'id' field!
  topic,
  subject,
  duration,
  voice,
  style,
});

// Supabase returns the newly created companion with a real UUID:
// companion.id = "a1b2c3d4-5678-90ab-cdef-1234567890ab"
```

## Bookmarking Starter Companions

### Why Bookmarking is Disabled

Starter companions **cannot be bookmarked** before they're created because:
1. They don't exist in the database yet
2. The bookmarks table requires a valid `companion_id` (FK constraint)
3. `"starter-1"` is not a valid UUID and not in the companions table

### Visual Indication

The StarterCompanionCard shows a **disabled bookmark icon**:

```tsx
<div className="companion-bookmark opacity-50 cursor-not-allowed">
  <Image src="/icons/bookmark.svg" alt="bookmark" />
</div>
```

- `opacity-50` - Grayed out appearance
- `cursor-not-allowed` - Shows "not allowed" cursor on hover
- No click handler - Button is non-functional

### After Creation

Once a user clicks "Launch Lesson":
1. Companion is created in database with real UUID
2. User is redirected to `/companions/{uuid}`
3. Companion now appears in "My Companions"
4. **Can now be bookmarked** like any regular companion

## Database Schema

### Companions Table
```sql
CREATE TABLE companions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),  -- ← Auto-generates UUID
  name TEXT NOT NULL,
  subject TEXT NOT NULL,
  topic TEXT NOT NULL,
  voice TEXT NOT NULL,
  style TEXT NOT NULL,
  duration INTEGER NOT NULL,
  author TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Bookmarks Table
```sql
CREATE TABLE bookmarks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  companion_id UUID REFERENCES companions(id) ON DELETE CASCADE,  -- ← Requires valid companion UUID
  user_id TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(companion_id, user_id)
);
```

## Code Flow

### 1. New User Sees Starter Companions
```typescript
// app/page.tsx
const isNewUser = userCompanions.length === 0;
const companions = isNewUser ? starterCompanions : await getAllCompanions({ limit: 3 });

// Renders StarterCompanionCard (no bookmark functionality)
<StarterCompanionCard
  key={companion.id}  // ← "starter-1" used here only
  name={companion.name}
  // ... (id NOT passed as prop)
/>
```

### 2. User Clicks "Launch Lesson"
```typescript
// components/companion/StarterCompanionCard.tsx
const handleLaunchLesson = async () => {
  const companion = await createFromStarter({
    name, topic, subject, duration, voice, style  // ← No id field!
  });
  
  router.push(`/companions/${companion.id}`);  // ← Real UUID from database
};
```

### 3. Server Creates Companion
```typescript
// lib/actions/companion.actions.ts
export const createFromStarter = async (starterData: CreateCompanion) => {
  const { userId: author } = await auth();
  const supabase = createSupabaseClient();

  const { data, error } = await supabase
    .from("companions")
    .insert({ ...starterData, author })  // ← Supabase generates UUID
    .select();

  return data[0];  // ← Returns companion with real UUID
};
```

### 4. User Can Now Bookmark
After creation, the companion:
- Has a real UUID (e.g., `"a1b2c3d4-..."`)
- Exists in `companions` table
- Can be bookmarked via `addBookmark(companionId, path)`
- Shows as a regular CompanionCard (with working bookmark button)

## Troubleshooting

### Error: "Companion not found" when bookmarking
**Cause**: Trying to bookmark a starter companion before creation  
**Solution**: This shouldn't happen - bookmark button is disabled on StarterCompanionCard

### Error: Invalid UUID format
**Cause**: Trying to use `"starter-1"` as a database ID  
**Solution**: Always use the UUID returned from `createFromStarter()`

### Starter companions appear in user's companions
**Status**: This is correct behavior!  
**Explanation**: Once created, they become regular companions owned by the user

## Summary

| Stage | ID Type | Can Bookmark? | Component |
|-------|---------|---------------|-----------|
| Template (before creation) | String (`"starter-1"`) | ❌ No | StarterCompanionCard (disabled bookmark) |
| After creation | UUID (generated by DB) | ✅ Yes | CompanionCard (normal bookmark) |

**Key Takeaway**: Starter companion IDs are just for React keys. Real UUIDs are generated by Supabase when the user creates them.
